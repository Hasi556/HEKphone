<?php

/**
 * AsteriskExtensionsTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class AsteriskExtensionsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object AsteriskExtensionsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('AsteriskExtensions');
    }

    /**
     * Deletes all entries in AsteriskExtension related to the phone $phone
     * @param Phones $phone
     */
    public function deletePhonesExtensions(Phones $phone)
    {
        $extensionPrefix = '8695';
        $this->createQuery()
            ->delete()
            ->where('exten = ?', $extensionPrefix . $phone->getExtension())
            ->orWhere('exten = ?', $phone->getExtension())
            ->execute();
    }

    /**
     * Deletes all entrys for the given extension
     * @param string $extension
     */
    public function deleteExtension($extension)
    {
        $this->createQuery()
            ->delete()
            ->where('exten = ?', $extension)
            ->execute();
    }

    /**
     * The function updates/creates the extension neccesary to dial a SIP-Phone.
     * If a resident is associated with the room, the extension is customized with
     * voicemailsettings etc.
     *
     * The extensions are generated in the context 'phones' which can be
     * included in the context 'locked' and 'unlocked' and 'amt' (which is
     * what you reach if you call from outside)
     *
     * @param Phones $phone
     * @return bool
     */
    public function createPhonesExtensions(Phones $phone)
    {
        if( ! $arrayExtensions = $phone->getExtensionsAsArray()) {
            return false;
        }

        // Insert the new extension in the database: //
        $collExtensions = Doctrine_Collection::create('AsteriskExtensions');
        $collExtensions->fromArray($arrayExtensions);
        $collExtensions->save();

        return true;
    }

    public function updateResidentsExtension(Residents $resident){
        $phone = Doctrine_Core::getTable('Phones')->findByResidentId($resident->get('id'));

        $this->deletePhonesExtensions($phone);
        $this->createPhonesExtensions($phone);
    }
}
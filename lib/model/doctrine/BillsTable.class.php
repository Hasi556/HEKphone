<?php

/**
 * BillsTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BillsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object BillsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Bills');
    }

    /**
     * Returns BillsCollection containing Bills for every resident who has
     * unbilled calls in the given time period that is not saved in the database.
     * Returns false when there are no calls in the time period.
     * @param datestring $start
     * @param datestring $end
     */
    public function getBillsCollectionForUnbilledCalls($start, $end)
    {
        if(strtotime($end) >= strtotime(date("Y-m-d"))) {
            throw new Exception("An end date in the future may lead to inconsistencies between calls marked as paid and the bill amount.");
            // TODO: Prevent this and remove this warning
        }

        //fetch the ids of all residents with unbilled calls from the given time period
        $residentidsWithUnbilledCalls = Doctrine_Query::create()
            ->from('Calls c')
            ->select('c.resident as residentid')
            ->addWhere('bill is null')
            ->addWhere('date <= ?', $end . ' 23:59:59')
            ->addWhere('date >= ?', $start)
            ->groupBy('resident')
            ->setHydrationMode(Doctrine::HYDRATE_SINGLE_SCALAR)
            ->execute();

        if(count($residentidsWithUnbilledCalls) == 0) {
            return false;
        }

        $billsCollection = new BillsCollection('Bills');
        foreach($residentidsWithUnbilledCalls as $residentid) {
            $billsCollection[$residentid]->resident = $residentid;
            $billsCollection[$residentid]->billingperiod_start = $start;
            $billsCollection[$residentid]->billingperiod_end = $end;
            $billsCollection[$residentid]->date = date("Y-m-d");
            $billsCollection[$residentid]->amount = $billsCollection[$residentid]->Residents->getBillAmountForTimeperiod($start, $end);
        }

        return $billsCollection;
    }

    /**
     * Delete bills older than sfConfig::get('monthsToKeepBillsFor');
     * @TODO: Delete the calls aswell (cascade)
     */
    public function deleteOldBills()
    {
        $this->createQuery()
            ->delete()
            ->where('date <= ?', date('Y-m-d',strtotime('-' . sfConfig::get('monthsToKeepBillsFor') . ' months')))
            ->execute();
    }
}